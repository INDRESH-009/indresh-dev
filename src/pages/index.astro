---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const lab = await getCollection("lab");
const notes = await getCollection("notes");
const projects = await getCollection("projects");

// ---------- helpers ----------
function stripExt(s: string) {
  return s.replace(/\.(md|mdx)$/, "");
}
function labUrl(entryId: string) {
  return `/lab/${stripExt(entryId)}`; // "2026/cycle-1.mdx" -> "/lab/2026/cycle-1"
}
function noteUrl(entry: any) {
  // entry.id is like "ml/probabilistic-view.mdx"
  const parts = entry.id.split("/");
  const rest = stripExt(parts.slice(1).join("/"));
  return `/notes/${entry.data.category}/${rest}`;
}

// ---------- pick "current cycle" (date-aware) ----------
function parseYMD(s: string) {
  // Interpret YYYY-MM-DD as a local date at midnight
  const [y, m, d] = s.split("-").map(Number);
  return new Date(y, (m ?? 1) - 1, d ?? 1, 0, 0, 0, 0);
}

const today = new Date();
const today0 = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0, 0);

// 1) Active by date: start <= today <= end
const activeByDate =
  lab.find((c) => {
    const start = parseYMD(c.data.start);
    const end = parseYMD(c.data.end);
    return start <= today0 && today0 <= end;
  }) ?? null;

// 2) Fallback: most recent "ongoing" by start date
const ongoingByStatus =
  [...lab]
    .filter((c) => c.data.status === "ongoing")
    .sort((a, b) => (b.data.start ?? "").localeCompare(a.data.start ?? ""))[0] ?? null;

// 3) Fallback: most recent by start date
const latestByStart =
  [...lab].sort((a, b) => (b.data.start ?? "").localeCompare(a.data.start ?? ""))[0] ?? null;

const currentCycle = activeByDate ?? ongoingByStatus ?? latestByStart;

// ---------- recent ----------
const recentNotes = [...notes]
  .sort((a, b) => (b.data.updated ?? "").localeCompare(a.data.updated ?? ""))
  .slice(0, 5);

const recentProjects = [...projects]
  .sort((a, b) => (b.data.started ?? "").localeCompare(a.data.started ?? ""))
  .slice(0, 4);

// ---------- homepage copy ----------
const intro = {
  title: "Hi, I’m Indresh.",
  p1: "Curiosity — to learn, to understand, to experiment, and to explain — drives my work.",
  p2: "I build and study machine learning models, particularly in computer vision and medical imaging. Much of my recent work has involved research and publications in these areas. At the same time, I’m drawn to problems that don’t fit neatly within a single field — often moving between mathematics, physics, biology, and real-world data.",
  p3: "Lately, I’ve been strengthening my mathematical foundations — especially probabilistic reasoning and understanding how representations are learned.",
  p4: "For a long time, I wanted a space where this exploration could be intentional rather than scattered — not isolated notes or repositories, but a coherent, evolving lab.",
  p5: "That’s why I built indresh.dev.",
  p6: "This is my working lab.",
  p7: "I operate in cycles — asking better questions, forming hypotheses, testing ideas, writing notes, and building projects that document my scientific explorations.",
};

const resumeHref = "/resume.pdf"; // put PDF in /public/resume.pdf
const portraitHref = "/profile.jpeg"; // put image in /public/profile-vertical.jpg
---
<BaseLayout title="indresh.dev">
  <h1 style="margin-top:10px">indresh.dev</h1>
  <p class="muted">
    Lab = Time · Notes = Truth · Projects = Capability · Research = Identity
  </p>

  <!-- HERO: Copy (left) + Portrait (right) -->
  <section class="card hero" style="margin-top:18px">
    <div class="hero-grid">
      <div class="hero-copy">
        <h2 style="margin-top:0">{intro.title}</h2>

        <p style="margin-top:10px">{intro.p1}</p>
        <p style="margin-top:10px">{intro.p2}</p>
        <p style="margin-top:10px">{intro.p3}</p>
        <p style="margin-top:10px">{intro.p4}</p>
        <p style="margin-top:10px">{intro.p5}</p>
        <p style="margin-top:10px">{intro.p6}</p>
        <p style="margin-top:10px">{intro.p7}</p>

        <div class="cta-row" style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
          <a class="btn btn-primary" href={resumeHref} download>Download resume (PDF)</a>
          <a class="btn" href="/about">About / philosophy</a>
          <a class="btn" href={currentCycle ? labUrl(currentCycle.id) : "/lab"}>Follow current cycle</a>
        </div>
      </div>

      <div class="hero-photo">
        <img src={portraitHref} alt="Portrait of Indresh" loading="lazy" />
      </div>
    </div>
  </section>

  <!-- Experience snapshot: separate card -->
  <section class="card" style="margin-top:14px">
    <h2 style="margin-top:0">Experience snapshot</h2>

    <div class="grid grid-3 proof-grid">
      <div class="proof-card">
        <div class="proof-title">ML Research Intern — Beatly Digital</div>
        <div class="muted">Continuous non-invasive BP (ECG/PPG) · Clinical datasets · Deployment-ready models</div>
      </div>

      <div class="proof-card">
        <div class="proof-title">Research Assistant — Jadavpur University</div>
        <div class="muted">Skin lesion segmentation · Cross-dataset generalization · Edge-efficient architectures</div>
      </div>

      <div class="proof-card">
        <div class="proof-title">Research Assistant — SRM × SIMS Hospital</div>
        <div class="muted">Coronary angiography segmentation · Anatomical vessel labeling · Clinical decision support</div>
      </div>
    </div>
  </section>

  <div class="grid grid-2" style="margin-top:18px">
    <section class="card">
      <h2 style="margin-top:0">Current cycle</h2>

      {currentCycle ? (
        <>
          <div class="muted">{currentCycle.data.start} → {currentCycle.data.end} · {currentCycle.data.status}</div>
          <div style="font-weight:800; font-size:1.1rem; margin-top:6px">
            <a href={labUrl(currentCycle.id)}>{currentCycle.data.title}</a>
          </div>

          {currentCycle.data.focus?.length > 0 && (
            <div class="muted" style="margin-top:6px">{currentCycle.data.focus.join(", ")}</div>
          )}

          {currentCycle.data.summary && <p style="margin-top:10px">{currentCycle.data.summary}</p>}

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <a class="btn" href="/lab">All cycles</a>
            <a class="btn" href="/notes">Notes</a>
            <a class="btn" href="/projects">Projects</a>
          </div>
        </>
      ) : (
        <>
          <p class="muted">No cycles yet. Create your first lab cycle in <code>src/content/lab/</code>.</p>
          <a class="btn" href="/lab">Go to Lab</a>
        </>
      )}
    </section>

    <section class="card">
      <h2 style="margin-top:0">How this site works</h2>
      <ul style="margin:0; padding-left:18px">
        <li><strong>Lab Notebook</strong>: cycle summaries, hypothesis → experiments → outcomes.</li>
        <li><strong>Notes</strong>: living explanations (math-friendly), revised over time.</li>
        <li><strong>Projects</strong>: reproducible builds with code + lessons.</li>
        <li><strong>Research</strong>: the emerging program and publications.</li>
      </ul>
      <p class="muted" style="margin-top:10px">
        One refined artifact per week beats daily noise.
      </p>
    </section>
  </div>

  <div class="grid grid-2" style="margin-top:14px">
    <section class="card">
      <h2 style="margin-top:0">Recent notes</h2>
      {recentNotes.length > 0 ? (
        <ul style="margin:0; padding-left:18px">
          {recentNotes.map((n) => (
            <li>
              <a href={noteUrl(n)}>{n.data.title}</a>
              <span class="muted"> · {n.data.updated}</span>
            </li>
          ))}
        </ul>
      ) : (
        <p class="muted">No notes yet.</p>
      )}
      <div style="margin-top:10px">
        <a class="btn" href="/notes">Browse notes</a>
      </div>
    </section>

    <section class="card">
      <h2 style="margin-top:0">Recent projects</h2>
      {recentProjects.length > 0 ? (
        <ul style="margin:0; padding-left:18px">
          {recentProjects.map((p) => (
            <li>
              <a href={`/projects/${p.slug}`}>{p.data.title}</a>
              <span class="muted"> · {p.data.status}</span>
            </li>
          ))}
        </ul>
      ) : (
        <p class="muted">No projects yet.</p>
      )}
      <div style="margin-top:10px">
        <a class="btn" href="/projects">Browse projects</a>
      </div>
    </section>
  </div>

  <style>
    .btn{
      display:inline-block;
      padding:8px 12px;
      border:1px solid rgba(0,0,0,.15);
      border-radius:12px;
      text-decoration:none;
      font-weight:600;
      background: rgba(0,0,0,.03);
    }
    .btn:hover{ background: rgba(0,0,0,.06); }

    .btn-primary{
      border-color: rgba(0,0,0,.25);
      background: rgba(0,0,0,.06);
    }
    .btn-primary:hover{
      background: rgba(0,0,0,.10);
    }

    /* HERO layout */
    .hero-grid{
      display:grid;
      grid-template-columns: 1.6fr 0.9fr;
      gap: 18px;
      align-items: start;
    }
    .hero-copy p{ max-width: 74ch; line-height: 1.65; margin: 10px 0; }

    .hero-photo{
      display:flex;
      justify-content: flex-end;
    }
    .hero-photo img{
      width: 100%;
      max-width: 320px;
      aspect-ratio: 3/5.5;
      object-fit: cover;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.02);
    }

    /* Experience cards */
    .proof-grid{ gap: 12px; }
    .proof-card{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.02);
    }
    .proof-title{
      font-weight: 800;
      margin-bottom: 6px;
    }

    /* If your .grid system doesn't include grid-3, this ensures it works */
    .grid-3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 900px){
      .hero-grid{ grid-template-columns: 1fr; }
      .hero-photo{ justify-content: flex-start; }
      .hero-photo img{ max-width: 360px; }
      .grid-3{ grid-template-columns: 1fr; }
    }
  </style>
</BaseLayout>